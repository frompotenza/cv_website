<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>felipe@potenza: ~</title>
  <style>
    body {
      background-color: #0a0a0a;
      color: #2ecc71;
      font-family: 'Courier New', Courier, monospace;
      padding: 20px;
      margin: 0;
      /* The page starts with no height and grows with the text */
      min-height: auto;
      overflow-y: auto;
      text-shadow: 0 0 5px #2ecc71;
    }

    /* CRT Effect */
    body::before {
      content: " ";
      display: block;
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%),
        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
      z-index: 10;
      background-size: 100% 4px, 3px 100%;
      pointer-events: none;
    }

    #terminal-container {
      display: flex;
      flex-direction: column;
      z-index: 1;
    }

    /* Standardizes vertical stacking for all history entries */
    #terminal-history div {
      display: block;
      width: 100%;
      white-space: pre-wrap;
      word-wrap: break-word;
      margin: 0;
      padding: 0;
      line-height: 1.2;
    }

    .input-line {
      display: flex;
      align-items: center;
      margin-top: 5px;
    }

    #user-input {
      background: transparent;
      border: none;
      color: #2ecc71;
      font-family: inherit;
      font-size: inherit;
      outline: none;
      flex-grow: 1;
      caret-color: #2ecc71;
    }

    .prompt {
      color: #8e44ad;
      margin-right: 10px;
      font-weight: bold;
    }

    .dir {
      color: #3498db;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <div id="terminal-container">
    <div id="terminal-history">
      <div>--- Welcome to Felipe Potenza's CV ---</div>
      <div>Type 'help' to see available commands.</div>
    </div>

    <div class="input-line">
      <span class="prompt">guest@pc:~$</span>
      <input type="text" id="user-input" autofocus autocomplete="off">
    </div>
  </div>

  <script>
    const input = document.getElementById('user-input');
    const history = document.getElementById('terminal-history');
    const promptLabel = document.querySelector('.prompt');

    const fileSystem = {
      'about_me': {
        'personal_info.txt': "file_system/personal_info.txt",
        'education.txt': "file_system/education.txt",
        'languages.txt': "file_system/languages.txt",
        'hobbies.txt': "file_system/hobbies.txt"
      },
      'experience': {
        'work_experience.txt': "file_system/work_experience.txt",
        'projects.txt': "file_system/projects.txt"
      },
      'contact.txt': "file_system/contact.txt",
      'skills.txt': "file_system/skills.txt"
    };

    let currentPath = [];

    function typeOutput(text, element) {
      let i = 0;
      const cleanText = text.trimEnd().replace(/\r/g, "");

      const interval = setInterval(() => {
        element.innerText += cleanText.charAt(i);
        i++;

        // Follow the text as it types
        window.scrollTo(0, document.body.scrollHeight);

        if (i >= cleanText.length) {
          clearInterval(interval);
        }
      }, 10);
    }

    function getCurrentDir() {
      return currentPath.reduce((dir, name) => dir[name], fileSystem);
    }

    let commandHistory = [];
    let historyIndex = -1;
    let currentInputBuffer = "";

    input.addEventListener('keydown', (e) => {
      const currentDir = getCurrentDir();
      const items = Object.keys(currentDir);

      if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (commandHistory.length > 0) {
          if (historyIndex === -1) currentInputBuffer = input.value;
          if (historyIndex < commandHistory.length - 1) {
            historyIndex++;
            input.value = commandHistory[commandHistory.length - 1 - historyIndex];
          }
        }
      }
      else if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (historyIndex > 0) {
          historyIndex--;
          input.value = commandHistory[commandHistory.length - 1 - historyIndex];
        } else if (historyIndex === 0) {
          historyIndex = -1;
          input.value = currentInputBuffer;
        }
      }
      else if (e.key === 'Tab') {
        e.preventDefault();
        const parts = input.value.split(' ');
        const lastPart = parts[parts.length - 1].toLowerCase();
        const matches = items.filter(item => item.toLowerCase().startsWith(lastPart));

        if (matches.length === 1) {
          parts[parts.length - 1] = matches[0];
          input.value = parts.join(' ');
        } else if (matches.length > 1) {
          const hint = document.createElement('div');
          hint.style.color = '#7f8c8d';
          hint.innerText = matches.join('   ');
          history.appendChild(hint);
          window.scrollTo(0, document.body.scrollHeight);
        }
      }
      else if (e.key === 'Enter') {
        const fullInput = input.value.trim();

        const outputLine = document.createElement('div');
        outputLine.innerHTML = `<span style="color:#8e44ad">${promptLabel.innerText}</span> ${fullInput}`;
        history.appendChild(outputLine);

        if (fullInput) {
          commandHistory.push(fullInput);
          historyIndex = -1;
          currentInputBuffer = "";
        } else {
          input.value = '';
          window.scrollTo(0, document.body.scrollHeight);
          return;
        }

        const [command, ...args] = fullInput.toLowerCase().split(' ');
        const arg = args[0];
        const response = document.createElement('div');

        // FIXED CLEAR: Uses <div> elements to maintain stack
        if (command === 'clear') {
          history.innerHTML = "<div>--- Welcome to Felipe Potenza's CV ---</div><div>Type 'help' to see available commands.</div>";
          input.value = '';
          window.scrollTo(0, 0);
          return;
        } else if (command === 'ls') {
          const formattedItems = Object.keys(currentDir).map(item =>
            typeof currentDir[item] === 'object' ? `<span class="dir">${item}/</span>` : item
          );
          response.innerHTML = formattedItems.join(' &nbsp; ');
        } else if (command === 'cd') {
          if (!arg || arg === '~') {
            currentPath = [];
          } else if (arg === '..') {
            currentPath.pop();
          } else if (currentDir[arg] && typeof currentDir[arg] === 'object') {
            currentPath.push(arg);
          } else {
            response.innerText = `cd: no such directory: ${arg}`;
          }
        } else if (command === 'cat') {
          const filePath = currentDir[arg];
          if (filePath && typeof filePath === 'string') {
            fetch(filePath)
              .then(res => res.ok ? res.text() : Promise.reject())
              .then(content => typeOutput(content, response))
              .catch(() => { response.innerText = `cat: error reading ${arg}`; });
          } else {
            response.innerText = `cat: ${arg || ''}: No such file`;
          }
        } else if (command === 'help') {
          response.innerText = "Available: ls, cd [dir], cat [file], clear, help, whoami";
        } else if (command === 'whoami') {
          fetch('file_system/personal_info.txt')
            .then(res => res.text())
            .then(content => typeOutput(content, response));
        } else {
          response.innerText = `-bash: ${command}: command not found`;
        }

        history.appendChild(response);
        const pathString = currentPath.length === 0 ? '~' : `~/${currentPath.join('/')}`;
        promptLabel.innerText = `guest@pc:${pathString}$`;
        input.value = '';

        // Final snap to the new prompt line
        window.scrollTo(0, document.body.scrollHeight);
      }
    });

    // Keep focus on input even when clicking elsewhere on the terminal
    document.addEventListener('click', () => input.focus());
  </script>
</body>

</html>